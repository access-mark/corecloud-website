<!-- Pie & Doughnut Chart Dashboard -->
<canvas id="dealCountChart" style="margin-bottom:2rem;"></canvas>
<canvas id="dealValueChart"></canvas>

<script>
  const ctx1 = document.getElementById('dealCountChart').getContext('2d');
  const ctx2 = document.getElementById('dealValueChart').getContext('2d');

  function renderDashboard(pipeline) {
    const stages = ['Qualification', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'];
    const counts = stages.map(stage => pipeline.filter(p => p.stage === stage).length);
    const totals = stages.map(stage => pipeline
      .filter(p => p.stage === stage)
      .reduce((sum, p) => sum + (parseFloat(p.dealValue) || 0), 0));

    new Chart(ctx1, {
      type: 'pie',
      data: {
        labels: stages,
        datasets: [{
          label: 'Deals per Stage',
          data: counts,
          backgroundColor: ['#004B87', '#005fa3', '#0073bf', '#FDC02F', '#ffdd75'],
          borderColor: '#ffffff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: stages,
        datasets: [{
          label: 'Deal Value (ZAR)',
          data: totals,
          backgroundColor: ['#FDC02F', '#fdd74f', '#fdeb7f', '#004B87', '#005fa3'],
          borderColor: '#ffffff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        cutout: '60%',
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  window.addEventListener('load', () => {
    setTimeout(() => {
      if (window.getPipelineData) {
        renderDashboard(window.getPipelineData());
      }
    }, 300);
  });
</script>
